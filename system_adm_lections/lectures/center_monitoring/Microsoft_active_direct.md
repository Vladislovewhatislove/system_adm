# Microsoft Active Directory

Центральным компонентом **Microsoft Active Directory** (**MS AD**) является служба **Domain Services**. 

Это иерархическая база данных, предназначенная для хранения информации о пользователях, компьютерах и тд. 

Эта база используется другими службами для *аутентификации* и *авторизации пользователей*, при доступе к сетевым ресурсам. 

Кроме этого в MS AD входит:

- компонент **управления групповыми политиками** (**Group Policy**) для автоматизации настроек ОС
- служба **управления сертификатами** (**Certificate Services**)
- службу **единого входа** (**Federation Services**) 
- службу **управления правами** (**Rights Management Services**) для управления доступа к объектам информационных систем.

**Federation Services** *позволяет организовать* **хранение учётных записей** любых *служб*.
Это позволяет авторизоваться в любых службах со всех компьютерах в домене, введя только один пароль от учётной записи. 
Служба не является аналогом **kerberos**, а представляет из себя расширением функционала.

**Rights Management Services** требует интеграции на уровне программного обеспечения, поэтому на данный момент поддерживается в ограниченном количестве программ. 
Вместе с **Certificate Services** эти три службы расширяют возможности 

Хоть **MS AD** рассчитана на использование в качестве клиентов и серверов ,только **ОС Microsift**, существуют реализации клиентов и серверов для **GNU/Linux** и **MacOS X**. 

Уровень функционала этих *решений разнится*, но это позволяет авторизоваться на *рабочей станции* или *в информационной системе*, используя учётную запись из домена **MS AD**.

Есть аналоги **MS AD** для *GNU/Linux* 
- **389 Directory Server**

## Domain Services

**Domaion Services** - комбинация из сетевых служб **LDAP** для *хранения информации об объектах* и **Kerberos** *для аутентификации.* 
*Информация о политиках безопасности* на клиенткой стороне ,хранится в базе **LDAP**, сами политики это текстовые файлы на сетевом ресурсе. 

## Group Policy

**Групповые политики** используются для централизованной настройки:
- окружения пользователя
- рабочих станций 
- серверов

**Групповая политика** - *тестовый файл* с перечислением пунктов и значением настроек

Настройки можно разделить на две большие группы:
- **для компьютеров**
- **для пользователей** 

За *применение настроек* на локальной машине отвечает **специальный клиент**. 
Политики обновляются каждый раз при перезагрузке компьютера или принудительно запуском утилиты **gpupdate.exe**

Чтобы связать групповую политику с объектами **MS AD** используются организационные единицы (**organizational unit**). Это контейнеры в каталоге **MS AD**, позволяющие *группировать другие объекты*. 
*Применение* **организационных единиц** - *связывание сгруппированных объектов* с действующими политиками. 
По аналогии с каталогами файловой системы, групповая политика действует на все объекты организационной единицы.
Для *создания политик*, *внесения изменения* и *связывания* с объектами каталога существует специальная оснастка в **mmc** консоли на сервере **MS AD** - **Group Policy Management**.

## Подключение клиентов

Для ввода в домен нового ПК потребуется установленный **контроллер домена**. 
*Корректность установки* проверяется утилитой **dcdiag**. 
Частая *ошибка* при установке - *некорректная настройка* **DNS** *сервера*. 
Для работы **MS AD** нужно разрешить домен-контроллеру вносить изменения в *DNS* записи
В этом случае при установке нужно,чтобы был установлен и настроен **DNS сервер**. 
Если **домен-контроллер** имеет **статический адрес**, то DNS сервер автоматически настроен.

Для *виртуальных машин* в системе **oVirt** для работы сети и службы DNS обязательно нужно выключить адресацию IPv6,а то будет ошибка с адресом домена.

Для *каждого клиента* в качестве **DNS сервера** должен быть установлен адрес **домен-контроллера**. 
После этого в *Windows* можно изменить **домен** 
Для входа в домен потребуется **учётная запись** *домена с правами*. 

С настройками по умолчанию:
- *пользователь* может ввести в домен **3 компьютера**
- *администратор* **без ограничений**. 

Можно **делегировать** права ввода в домен *специальным учётным записям*, чтобы  операцию могли **проводить** техники **без администратора**.

При подключении **Linux** в домен будет доступна **централизованная аутентификация** *через базу домена* и возможность использовать группы безопасности,хоть они и не поддерживаются. 
Существует *два варианта* включения *Linux* в домен **MS AD**: с помощью **sssd** или **winbind/samba**. 

В первом случае потребуется установка службы **sssd** с зависимостями:

`apt -y install realmd sssd sssd-tools adcli krb5-user packagekit samba-common samba-common-bin samba-libs resolvconf`

*Проверить доступности домена:*

`realm discover mydomain.local`

*Подключиться к нему с помощью команды*

`realm join mydomain.local`

Добавить настройку, создающую профиль пользователя домена при первом входе. 
Для этого в файле **/etc/pam.d/common-session** добавить строчку:
`session optional        pam_mkhomedir.so skel=/etc/skel umask=077`